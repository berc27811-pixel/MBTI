# 访问追踪系统部署说明

## 系统概述

新的访问追踪系统采用以下核心优化：

1. **身份识别**：使用 Cookie + UUID（唯一身份ID）替代 IP+UA，确保用户身份的持久性
2. **数据存储**：使用 MySQL 数据库替代 localStorage，提供无限容量和快速查询
3. **前后端分离**：前端负责发送信号，后端负责数据存储和处理
4. **支付保护**：只有支付后的订单才能保存测试结果

## 数据库表结构

### 1. visitors 表（访客表）

解决 UV/IP 变动问题，使用 UUID 作为唯一身份标识。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| uuid | VARCHAR(64) | 唯一身份ID（Cookie存储） |
| first_visit_ip | VARCHAR(45) | 首次访问IP |
| user_agent | TEXT | 用户代理字符串 |
| created_at | DATETIME | 创建时间 |

### 2. orders 表（订单表）

确保付了钱才能看结果。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| order_no | VARCHAR(32) | 订单号（唯一） |
| visitor_uuid | VARCHAR(64) | 关联访客UUID |
| amount | DECIMAL(10,2) | 订单金额 |
| status | ENUM('pending', 'paid') | 支付状态 |
| payment_method | VARCHAR(20) | 支付方式 |
| paid_at | DATETIME | 支付时间 |
| created_at | DATETIME | 创建时间 |

### 3. test_results 表（测试结果表）

存储用户的答题记录。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| order_no | VARCHAR(32) | 关联订单号 |
| mbti_type | VARCHAR(4) | MBTI类型（如INTJ） |
| scores | JSON | 详细维度得分 |
| answers | JSON | 用户选择的答案 |
| created_at | DATETIME | 创建时间 |

## 文件清单

### 新增文件
- [db_config.php](file:///c:/Users/chuckm6/Desktop/mbti-website/db_config.php) - 数据库配置和连接管理
- [api_visitor.php](file:///c:/Users/chuckm6/Desktop/mbti-website/api_visitor.php) - 后端API接口
- [init_database.php](file:///c:/Users/chuckm6/Desktop/mbti-website/init_database.php) - 数据库初始化脚本
- [test_tracker.html](file:///c:/Users/chuckm6/Desktop/mbti-website/test_tracker.html) - 访问追踪系统测试页面

### 修改文件
- [accessTracker.js](file:///c:/Users/chuckm6/Desktop/mbti-website/accessTracker.js) - 重写为基于Cookie + UUID的全新实现

## 部署步骤

### 第一步：创建数据库表

有两种方式创建数据库表：

#### 方式1：使用 phpMyAdmin（推荐）

1. 登录你的服务器控制面板（如宝塔面板、cPanel）
2. 找到 phpMyAdmin 或数据库管理工具
3. 选择数据库：`mbti_dewater_icu`
4. 点击 SQL 选项卡
5. 复制并执行以下SQL代码：

```sql
-- 1. 访客表：解决UV/IP变动问题
CREATE TABLE `visitors` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `uuid` VARCHAR(64) NOT NULL UNIQUE COMMENT '唯一身份ID',
    `first_visit_ip` VARCHAR(45) COMMENT '首次访问IP',
    `user_agent` TEXT COMMENT '用户代理字符串',
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    KEY `idx_uuid` (`uuid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='访客信息表';

-- 2. 订单表：确保付了钱才能看结果
CREATE TABLE `orders` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `order_no` VARCHAR(32) NOT NULL UNIQUE COMMENT '订单号',
    `visitor_uuid` VARCHAR(64) NOT NULL COMMENT '关联访客UUID',
    `amount` DECIMAL(10,2) NOT NULL COMMENT '订单金额',
    `status` ENUM('pending', 'paid') DEFAULT 'pending' COMMENT '支付状态',
    `payment_method` VARCHAR(20) COMMENT '支付方式',
    `paid_at` DATETIME COMMENT '支付时间',
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    KEY `idx_order_no` (`order_no`),
    KEY `idx_visitor_uuid` (`visitor_uuid`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单信息表';

-- 3. 结果表：存储用户的答题记录
CREATE TABLE `test_results` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `order_no` VARCHAR(32) NOT NULL COMMENT '关联订单号',
    `mbti_type` VARCHAR(4) COMMENT 'MBTI类型，例如INTJ',
    `scores` JSON COMMENT '详细维度得分',
    `answers` JSON COMMENT '用户选择的答案',
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    KEY `idx_order_no` (`order_no`),
    KEY `idx_mbti_type` (`mbti_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='测试结果表';
```

#### 方式2：使用 init_database.php 脚本

1. 将所有文件上传到服务器
2. 在浏览器中访问：`https://你的域名.com/init_database.php`
3. 脚本会自动创建三张表并显示结果

### 第二步：上传文件

将以下文件上传到你的网站根目录：

```
mbti-website/
├── db_config.php
├── api_visitor.php
├── accessTracker.js
├── init_database.php
├── test_tracker.html
└── ... (其他现有文件)
```

### 第三步：测试系统

1. 在浏览器中访问：`https://你的域名.com/test_tracker.html`
2. 查看当前访客信息（UUID、访问次数等）
3. 测试各项功能：
   - 注册访客
   - 创建订单
   - 更新订单状态
   - 保存测试结果
   - 获取统计信息

### 第四步：验证功能

1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签，应该看到类似输出：
   ```
   使用现有访客UUID: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
   这是您第 3 次访问本站
   访客注册成功: 访客已存在
   ```

3. 查看 Application 标签 → Cookies，应该看到：
   - `mbti_visitor_uuid` - 访客唯一标识
   - `mbti_first_visit` - 首次访问时间
   - `mbti_visit_count` - 访问次数

## API 接口说明

### 1. 注册访客

**请求：**
```
POST /api_visitor.php
Content-Type: application/x-www-form-urlencoded

action=register_visitor
&uuid=xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
&user_agent=Mozilla/5.0...
```

**响应：**
```json
{
  "success": true,
  "message": "访客注册成功",
  "visitor_id": 1
}
```

### 2. 创建订单

**请求：**
```
POST /api_visitor.php
Content-Type: application/x-www-form-urlencoded

action=create_order
&visitor_uuid=xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
&amount=9.90
&payment_method=alipay
```

**响应：**
```json
{
  "success": true,
  "message": "订单创建成功",
  "order_id": 1,
  "order_no": "MBTI2026010312300012345"
}
```

### 3. 更新订单状态

**请求：**
```
POST /api_visitor.php
Content-Type: application/x-www-form-urlencoded

action=update_order_status
&order_no=MBTI2026010312300012345
&status=paid
```

**响应：**
```json
{
  "success": true,
  "message": "订单状态更新成功"
}
```

### 4. 保存测试结果

**请求：**
```
POST /api_visitor.php
Content-Type: application/x-www-form-urlencoded

action=save_test_result
&order_no=MBTI2026010312300012345
&mbti_type=INTJ
&scores={"E":20,"I":10,"S":15,"N":15,"T":18,"F":12,"J":16,"P":14}
&answers={"question1":"A","question2":"B"}
```

**响应：**
```json
{
  "success": true,
  "message": "测试结果保存成功",
  "result_id": 1
}
```

**注意**：只有订单状态为 `paid` 时才能保存测试结果。

### 5. 获取统计信息

**请求：**
```
GET /api_visitor.php?action=get_stats
```

**响应：**
```json
{
  "success": true,
  "stats": {
    "total_visitors": 100,
    "today_visitors": 10,
    "total_orders": 50,
    "paid_orders": 40,
    "today_orders": 5,
    "today_paid": 4,
    "total_revenue": 396.00,
    "today_revenue": 39.60,
    "total_tests": 40
  }
}
```

## 前端使用示例

### 基本使用

```javascript
// 访问追踪器会自动初始化并注册访客
// 无需手动调用，只需引入 accessTracker.js 即可

<script src="accessTracker.js"></script>
```

### 创建订单

```javascript
// 创建订单
const result = await accessTracker.createOrder(9.90, 'alipay');
if (result.success) {
    console.log('订单号:', result.order_no);
    // 保存订单号用于后续支付和保存结果
    localStorage.setItem('currentOrderNo', result.order_no);
}
```

### 更新订单状态

```javascript
// 支付成功后更新订单状态
const orderNo = localStorage.getItem('currentOrderNo');
const result = await accessTracker.updateOrderStatus(orderNo, 'paid');
if (result.success) {
    console.log('订单已支付');
}
```

### 保存测试结果

```javascript
// 保存测试结果（只有已支付的订单才能保存）
const orderNo = localStorage.getItem('currentOrderNo');
const scores = {
    E: 20, I: 10,
    S: 15, N: 15,
    T: 18, F: 12,
    J: 16, P: 14
};
const answers = {
    question1: 'A',
    question2: 'B',
    // ... 所有答案
};

const result = await accessTracker.saveTestResult(orderNo, 'INTJ', scores, answers);
if (result.success) {
    console.log('测试结果已保存');
} else {
    console.error('保存失败:', result.error);
    // 可能是订单未支付
}
```

### 获取统计信息

```javascript
// 获取统计信息
const stats = await accessTracker.getStats();
console.log('总收入:', stats.total_revenue);
console.log('今日访客:', stats.today_visitors);
```

## Cookie 说明

系统使用以下 Cookie：

| Cookie 名称 | 说明 | 过期时间 |
|------------|------|---------|
| mbti_visitor_uuid | 访客唯一标识 | 365天 |
| mbti_first_visit | 首次访问时间 | 365天 |
| mbti_visit_count | 访问次数 | 365天 |

## 数据库配置

数据库配置信息已在 [db_config.php](file:///c:/Users/chuckm6/Desktop/mbti-website/db_config.php) 中设置：

```php
private $config = [
    'host' => 'localhost',
    'dbname' => 'mbti_dewater_icu',
    'username' => 'mbti_dewater_icu',
    'password' => 'fTasYKzah8mbCEwa',
    'charset' => 'utf8mb4'
];
```

如需修改配置，请编辑 `db_config.php` 文件。

## 优势总结

1. **身份持久性**：使用 Cookie + UUID，即使用户IP变化或浏览器升级，仍能识别为同一用户
2. **数据可靠性**：MySQL 数据库提供事务支持和数据备份，不会丢失数据
3. **查询性能**：数据库索引优化，支持快速查询和统计
4. **扩展性**：可以轻松添加更多字段和功能
5. **安全性**：后端验证和参数化查询，防止SQL注入
6. **支付保护**：只有支付后的订单才能保存测试结果，确保付费才能查看结果

## 工作流程

### 完整的测试流程

1. **访客访问网站**
   - 前端自动生成或获取 UUID
   - 调用 `registerVisitor()` 注册访客
   - 数据库记录访客信息

2. **用户开始测试**
   - 用户完成测试
   - 前端计算 MBTI 类型

3. **创建订单**
   - 调用 `createOrder()` 创建订单
   - 订单状态为 `pending`
   - 获取订单号

4. **用户支付**
   - 用户完成支付
   - 调用 `updateOrderStatus()` 更新订单为 `paid`

5. **保存测试结果**
   - 调用 `saveTestResult()` 保存结果
   - 后端验证订单是否已支付
   - 只有已支付的订单才能保存结果

6. **查看结果**
   - 调用 `getTestResult()` 获取结果
   - 显示测试结果

## 故障排查

### 问题1：数据库连接失败

**症状**：访问页面时显示"数据库连接失败"

**解决方案**：
1. 检查 [db_config.php](file:///c:/Users/chuckm6/Desktop/mbti-website/db_config.php) 中的数据库配置是否正确
2. 确认数据库服务是否运行
3. 检查数据库用户权限

### 问题2：访客注册失败

**症状**：测试页面显示"访客注册失败"

**解决方案**：
1. 检查 `visitors` 表是否创建成功
2. 查看浏览器控制台是否有错误信息
3. 检查 [api_visitor.php](file:///c:/Users/chuckm6/Desktop/mbti-website/api_visitor.php) 文件权限

### 问题3：Cookie 未设置

**症状**：每次刷新页面都创建新的UUID

**解决方案**：
1. 检查浏览器是否禁用了Cookie
2. 检查网站是否使用HTTPS（某些浏览器要求HTTPS才能设置Cookie）
3. 检查 Cookie 的 domain 和 path 设置

### 问题4：测试结果保存失败

**症状**：显示"订单未支付，无法保存测试结果"

**解决方案**：
1. 检查订单号是否正确
2. 检查订单状态是否为 `paid`
3. 确认用户已完成支付

## 维护建议

1. **定期备份数据库**：建议每天备份一次数据库
2. **清理旧数据**：可以定期清理6个月前的访客记录
3. **监控性能**：关注数据库查询性能，必要时添加索引
4. **日志分析**：定期分析访问日志，了解用户行为
5. **收入统计**：定期查看统计信息，了解收入情况

## 技术支持

如有问题，请联系：
- 邮箱：chuck@mbti.ink
